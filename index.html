<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GoldMIND AI Ultimate Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="assets/fwvgoldmind-favicon.png" type="image/png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-color:#0d1a26;
      --text-color:#f0f0f0;
      --card-bg:rgba(25,40,55,.9);
      --primary-gold:#ffd700;
      --secondary-gold:#ffecb3;
    }
    [data-theme="light"]{
      --bg-color:#f8f9fa; --text-color:#343a40; --card-bg:#fff;
      --primary-gold:#daa520; --secondary-gold:#ffd700;
    }
    body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg-color);color:var(--text-color);min-height:100vh;display:flex;flex-direction:column;transition:background .4s,color .4s;}
    .container{flex-grow:1}

    .card{background:var(--card-bg);border-radius:16px;border:1px solid rgba(255,215,0,.12);box-shadow:0 8px 20px rgba(0,0,0,.3);overflow:hidden;min-height:260px;transition:transform .25s,box-shadow .25s;}
    .card:hover{transform:translateY(-3px);box-shadow:0 12px 26px rgba(0,0,0,.4);}
    .card-header{background:linear-gradient(90deg,var(--primary-gold),var(--secondary-gold));color:#1a1a1a;padding:1rem 1.25rem;font-weight:600;display:flex;align-items:center;justify-content:space-between;}
    .card-body{padding:1.25rem}
    .data-badge{padding:6px 12px;border-radius:20px;background:linear-gradient(45deg,var(--primary-gold),var(--secondary-gold));color:#1a1a1a;font-weight:600}

    .navbar-transparent{background:rgba(13,26,38,.7);border-radius:12px;padding:1rem 2rem;backdrop-filter:blur(10px);box-shadow:0 4px 15px rgba(0,0,0,.2);}
    .navbar-dark{background-color:var(--bg-color)!important}
    .navbar-brand{display:flex;flex-direction:column;align-items:center;color:var(--text-color)!important;text-align:center;font-weight:700}
    .navbar-brand img{height:200px;border-radius:8px;margin-bottom:6px}
    .brand-text-container{display:flex;flex-direction:column;align-items:center}
    .ultimate-text{font-size:1.2rem;font-weight:400;line-height:1}
    .presented-by-text{font-size:.7rem;font-weight:300;margin-top:3px;line-height:1}
    .btn-header{margin-left:10px;padding:.6rem 1.2rem;border-radius:30px;border:none;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.2);transition:transform .2s}
    .btn-header:hover{transform:translateY(-2px)}

    .chart-container{height:260px;margin-bottom:12px}
    .mini-chart{height:120px}

    /* Tighten only the three tool cards */
    .card.h-tools{min-height:170px}
    .card.h-tools .card-body{padding:.9rem 1rem}
    .card.h-tools .jsection-input-group{gap:8px;margin-bottom:10px}
    .card.h-tools .jsection-result{min-height:56px;padding:10px}

    .input-group-text{background:#0f2635;color:#cfe5f3;border-color:rgba(255,255,255,.12)}
    .form-text{color:#98a9b6!important;font-size:.8rem}

    @media (max-width:991.98px){
      .navbar-brand img{height:120px}
      .card{min-height:auto}
    }
  </style>
</head>

<body data-theme>
  <!-- HEADER -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-transparent mb-4">
    <a class="navbar-brand" href="#" data-intro="Welcome to your GoldMIND AI Dashboard!">
      <img src="assets/GoldMind AI logo.png" alt="GoldMIND AI Logo">
      <div class="brand-text-container">
        <span class="ultimate-text">Ultimate Trading Companion</span>
        <span class="presented-by-text">Presented by Foster Wealth Ventures LLC</span>
      </div>
    </a>
    <div class="ms-auto d-flex align-items-center">
      <button class="btn btn-outline-light btn-header" id="helpBtn">Help</button>
      <button class="btn btn-info btn-header" id="themeToggle">Toggle Theme</button>
      <button class="btn btn-secondary btn-header" data-bs-toggle="offcanvas" data-bs-target="#settingsCanvas">Settings</button>
      <button class="btn btn-warning btn-header" id="walkthroughBtn">Walkthrough</button>
      <button class="btn btn-danger btn-header" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Summary row -->
    <div class="row g-4 mb-4">
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-header">Market Status <span class="data-badge">Active</span></div>
          <div class="card-body">
            <p class="card-text text-white">Current Market Regime: <strong class="text-info">Trending Up</strong></p>
            <p class="card-text text-white">Volatility Index: <strong class="text-warning">Low</strong></p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-header">Today's Recommendation <span class="data-badge">Gold</span></div>
          <div class="card-body">
            <h5 class="card-title text-success">BUY</h5>
            <p class="card-text text-white">Entry: $2350 | Target: $2400</p>
            <p class="card-text text-white">Confidence: <strong class="text-success">92%</strong></p>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-header">Bias Alert <span class="data-badge">High</span></div>
          <div class="card-body">
            <h5 class="card-title text-warning">Overconfidence Bias Detected!</h5>
            <p class="card-text text-white">Review your recent high-risk trades.</p>
            <button class="btn btn-sm btn-outline-info mt-2">Learn More</button>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3">
        <div class="card">
          <div class="card-header">Portfolio Overview <span class="data-badge">USD</span></div>
          <div class="card-body">
            <p class="card-text text-white">Current Value: <strong class="text-success">$125,450</strong></p>
            <p class="card-text text-white">Daily Change: <strong class="text-success">+1.2%</strong></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">Gold Price Performance <span class="data-badge">Live Data</span></div>
          <div class="card-body">
            <div class="chart-container"><canvas id="goldPriceChart"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">Recommendation History <span class="data-badge">Last 7 Days</span></div>
          <div class="card-body">
            <div class="chart-container"><canvas id="recommendationHistoryChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tools: LSTM / Bias / Decision Engine -->
    <div class="row g-4 mb-4 align-items-stretch">
      <!-- LSTM -->
      <div class="col-md-4">
        <div class="card h-100 h-tools">
          <div class="card-header">LSTM Price Prediction</div>
          <div class="card-body">
            <div class="jsection-input-group">
              <label for="predictInput">Enter price sequence (comma separated):</label>
              <input id="predictInput" class="form-control" placeholder="e.g. 2000,2010,2025,2035" />
            </div>
            <button id="predictBtn" class="btn btn-primary w-100">Get Prediction</button>
            <div class="jsection-result mt-2"><pre id="predictResult">Results will appear here</pre></div>
          </div>
        </div>
      </div>

      <!-- Bias / Sentiment -->
      <div class="col-md-4">
        <div class="card h-100 h-tools">
          <div class="card-header">Bias / Sentiment Analysis</div>
          <div class="card-body">
            <div class="jsection-input-group">
              <label for="analyzeText">What's your trade idea?</label>
              <input id="analyzeText" class="form-control" placeholder="I think gold will rise because..." />
            </div>
            <div class="jsection-input-group">
              <label for="analyzeUserId">User ID</label>
              <input id="analyzeUserId" class="form-control" placeholder="Your user ID" />
            </div>
            <button id="analyzeBtn" class="btn btn-warning w-100">Analyze Text</button>
            <div class="jsection-result mt-2"><pre id="analyzeResult">Analysis results will appear here</pre></div>
          </div>
        </div>
      </div>

      <!-- Decision Engine -->
      <div class="col-md-4">
        <div class="card decision-engine-card h-100 h-tools">
          <div class="card-header">GoldMIND Decision Engine</div>
          <div class="card-body">
            <div class="jsection-input-group">
              <label for="resolveInput">Enter price sequence (comma separated):</label>
              <input id="resolveInput" class="form-control" placeholder="e.g. 2000,2010,2025,2035" />
            </div>
            <div class="jsection-input-group">
              <label for="resolveText">What's your reasoning?</label>
              <input id="resolveText" class="form-control" placeholder="Explain your analysis..." />
            </div>
            <div class="jsection-input-group">
              <label for="resolveUserId">User ID</label>
              <input id="resolveUserId" class="form-control" placeholder="Your user ID" />
            </div>
            <div class="jsection-input-group">
              <label for="tradingStyle">Trading Style</label>
              <select id="tradingStyle" class="form-select">
                <option value="">Select Trading Style</option>
                <option>Day Trading</option><option>Swing Trading</option><option>Position Trading</option><option>Scalping</option>
              </select>
            </div>
            <div class="jsection-input-group">
              <label for="timeFrame">Time Frame</label>
              <select id="timeFrame" class="form-select">
                <option value="">Select Time Frame</option>
                <option>15m</option><option>30m</option><option>1h</option><option>4h</option><option>1d</option>
              </select>
            </div>

            <div class="jsection-input-group">
              <label for="investmentAmount">Investment Amount (USD)</label>
              <input id="investmentAmount" type="number" min="0" class="form-control" placeholder="Enter amount" />
            </div>

            <div class="row g-2">
              <div class="col-6">
                <div class="jsection-input-group mb-0">
                  <label for="entryPrice">Entry Price (USD)</label>
                  <input id="entryPrice" type="number" step="0.01" min="0" class="form-control" placeholder="e.g. 2032.50" />
                </div>
              </div>
              <div class="col-6">
                <div class="jsection-input-group mb-0">
                  <label for="pips">Distance in Pips</label>
                  <div class="input-group">
                    <input id="pips" type="number" step="1" min="0" class="form-control" placeholder="e.g. 200" />
                    <span class="input-group-text">pips</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-text mt-1">1 pip = $0.01 for XAUUSD (100 pips = $1.00)</div>

            <div class="jsection-input-group mt-2">
              <label for="targetPrice">Target Price (calculated)</label>
              <input id="targetPrice" type="number" step="0.01" class="form-control" placeholder="e.g. 2034.50" />
            </div>

            <button id="resolveBtn" class="btn btn-success w-100 mt-1">Get Final Decision</button>
            <div class="jsection-result mt-2"><pre id="resolveResult">Decision results will appear here</pre></div>
          </div>
        </div>
      </div>
    </div>

    <!-- XAI row: Feature Importance / Bias Influence / Scenario Traceability -->
    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">Feature Importance</div>
          <div class="card-body">
            <p class="card-text text-white mb-2">Top contributors driving predictions.</p>
            <div class="chart-container mini-chart">
              <canvas id="featureImportanceChart"></canvas>
            </div>
            <button class="btn btn-sm btn-outline-info w-100">View Details</button>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">Bias Influence Map</div>
          <div class="card-body">
            <p class="card-text text-white mb-2">Detected cognitive biases & mitigation.</p>
            <div class="chart-container mini-chart">
              <canvas id="biasInfluenceMap"></canvas>
            </div>
            <button class="btn btn-sm btn-outline-info w-100">Explore Biases</button>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">Scenario Traceability</div>
          <div class="card-body">
            <p class="card-text text-white">Trace any prior recommendation.</p>

            <div class="jsection-input-group">
              <label for="recommendationId" class="form-label text-white">Recommendation ID</label>
              <input type="text" class="form-control bg-dark text-white" id="recommendationId" placeholder="e.g., REC-20230726-001" />
            </div>

            <button id="traceBtn" class="btn btn-sm btn-outline-info w-100 mb-2">Trace Recommendation</button>

            <div id="traceInline" class="jsection-result mt-2" style="display:none;">
              <pre id="traceInlineContent">—</pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback (hidden until decision) -->
    <div class="row g-4 mb-4">
      <div class="col-md-3"></div><div class="col-md-3"></div><div class="col-md-3"></div>
      <div class="col-md-3">
        <div class="card h-100" id="feedbackSection" style="display:none;">
          <div class="card-header">Feedback & Improvement</div>
          <div class="card-body">
            <div class="jsection-input-group">
              <label for="feedbackFollowed">Did you follow the recommendation?</label>
              <select id="feedbackFollowed" class="form-select">
                <option value="">Choose...</option><option value="yes">Yes</option><option value="no">No</option><option value="partial">Partial</option>
              </select>
            </div>
            <div class="jsection-input-group">
              <label for="feedbackText">What happened?</label>
              <textarea id="feedbackText" class="form-control bg-dark text-white" rows="3" placeholder="Share outcome, slippage, fills, etc."></textarea>
            </div>
            <button class="btn btn-primary w-100" id="feedbackBtn">Submit Feedback</button>
            <div class="jsection-result mt-2"><pre id="feedbackResult">Waiting for feedback...</pre></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Walkthrough Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="videoModalLabel">Dashboard Walkthrough</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="ratio ratio-16x9">
              <iframe id="walkthroughVideo" src="https://www.youtube.com/embed/VIDEO_ID?enablejsapi=1" allow="autoplay"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Trace Modal -->
    <div class="modal fade" id="traceModal" tabindex="-1" aria-labelledby="traceModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="traceModalLabel">Recommendation Trace</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="traceSummary" class="mb-3 small text-muted"></div>
            <ol id="traceTimeline" class="list-group list-group-numbered"></ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsCanvas" aria-labelledby="settingsLabel">
      <div class="offcanvas-header">
        <h5 id="settingsLabel">Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="toggleSmoothLines" checked />
          <label class="form-check-label" for="toggleSmoothLines">Smooth lines on charts</label>
        </div>

        <div class="mb-3">
          <label for="defaultTradingStyle" class="form-label">Default Trading Style</label>
          <select id="defaultTradingStyle" class="form-select">
            <option value="">Select Trading Style</option>
            <option>Day Trading</option><option>Swing Trading</option><option>Position Trading</option><option>Scalping</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="defaultTimeFrame" class="form-label">Default Time Frame</label>
          <select id="defaultTimeFrame" class="form-select">
            <option value="">Select Time Frame</option>
            <option>15m</option><option>30m</option><option>1h</option><option>4h</option><option>1d</option>
          </select>
        </div>

        <button class="btn btn-success" id="saveSettingsBtn">Save Settings</button>
        <div class="mt-3 small" id="settingsStatus" aria-live="polite"></div>
      </div>
    </div>
  </div><!-- /.container -->

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- APP JS -->
  <script>
    console.log('GM dashboard loaded v-trace-002');

    const API_BASE = 'https://api.fwvgoldmindai.com';
    const ENDPOINTS = {
      logout: `${API_BASE}/logout`,
      settings: `${API_BASE}/settings`,
      predict: `${API_BASE}/predict`,
      analyzeText: `${API_BASE}/analyze/text`,
      resolve: `${API_BASE}/resolve`,
      feedback: `${API_BASE}/feedback`,
      trace: `${API_BASE}/trace`,
    };
    const LOGIN_URL = '/login.html';

    async function apiFetch(url, options = {}) {
      const token = localStorage.getItem('auth_token');
      const headers = options.headers ? {...options.headers} : {};
      if (token) headers['Authorization'] = `Bearer ${token}`;
      if (!headers['Content-Type'] && options.body && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
      }
      const res = await fetch(url, {...options, headers});
      let data; try { data = await res.json(); } catch { data = null; }
      if (!res.ok) {
        const msg = (data && (data.message || data.error)) || res.statusText;
        const err = new Error(msg); err.status = res.status; err.data = data;
        throw err;
      }
      return data;
    }

    function applyDefaultsToDecisionEngine(defaults) {
      if (defaults?.default_trading_style) {
        const sel = document.getElementById('tradingStyle'); if (sel) sel.value = defaults.default_trading_style;
      }
      if (defaults?.default_time_frame) {
        const tf = document.getElementById('timeFrame'); if (tf) tf.value = defaults.default_time_frame;
      }
    }

    async function loadSettings() {
      const status = document.getElementById('settingsStatus');
      const local = JSON.parse(localStorage.getItem('gm_settings') || '{}');
      if (typeof local.smooth_lines === 'boolean') document.getElementById('toggleSmoothLines').checked = local.smooth_lines;
      if (local.default_trading_style) document.getElementById('defaultTradingStyle').value = local.default_trading_style;
      if (local.default_time_frame) document.getElementById('defaultTimeFrame').value = local.default_time_frame;

      const token = localStorage.getItem('auth_token');
      if (!token) { status.textContent = 'Settings loaded locally.'; return local; }

      try {
        const server = await apiFetch(ENDPOINTS.settings, { method: 'GET' });
        const merged = {
          smooth_lines: typeof server.smooth_lines === 'boolean' ? server.smooth_lines : (local.smooth_lines ?? true),
          default_trading_style: server.default_trading_style || local.default_trading_style || '',
          default_time_frame: server.default_time_frame || local.default_time_frame || ''
        };
        document.getElementById('toggleSmoothLines').checked = merged.smooth_lines;
        document.getElementById('defaultTradingStyle').value = merged.default_trading_style;
        document.getElementById('defaultTimeFrame').value = merged.default_time_frame;
        localStorage.setItem('gm_settings', JSON.stringify(merged));
        status.textContent = 'Settings synced from server.';
        return merged;
      } catch (e) {
        status.textContent = 'Using local settings.';
        return local;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Theme
      const body = document.body;
      const themeToggle = document.getElementById('themeToggle');
      const curTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
      body.setAttribute('data-theme', curTheme);
      themeToggle?.addEventListener('click', () => {
        const next = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', next); localStorage.setItem('theme', next);
      });

      // Walkthrough modal
      const videoModal = document.getElementById('videoModal');
      const walkthroughVideo = document.getElementById('walkthroughVideo');
      document.getElementById('walkthroughBtn')?.addEventListener('click', () => new bootstrap.Modal(videoModal).show());
      videoModal?.addEventListener('shown.bs.modal', () => {
        if (walkthroughVideo?.contentWindow?.postMessage) {
          walkthroughVideo.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        } else {
          walkthroughVideo.src += (walkthroughVideo.src.includes('?') ? '&' : '?') + 'autoplay=1';
        }
      });
      videoModal?.addEventListener('hidden.bs.modal', () => {
        if (walkthroughVideo?.contentWindow?.postMessage) {
          walkthroughVideo.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        } else {
          walkthroughVideo.src = walkthroughVideo.src.replace("&autoplay=1", "");
        }
      });

      // Charts
      const goldPriceCtx = document.getElementById('goldPriceChart')?.getContext('2d');
      if (goldPriceCtx) {
        const goldPriceChart = new Chart(goldPriceCtx, {
          type: 'line',
          data: { labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul'], datasets: [{ label:'Gold Price (USD)', data:[2000,2050,2100,2200,2300,2350,2380], borderColor:'rgba(255,215,0,1)', backgroundColor:'rgba(255,215,0,0.1)', fill:true, tension:0.4 }] },
          options: { responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ labels:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } } },
            scales:{ x:{ grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } },
                    y:{ grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } } }
          }
        });
        document.getElementById('toggleSmoothLines')?.addEventListener('change', (e) => {
          goldPriceChart.data.datasets[0].tension = e.target.checked ? 0.4 : 0;
          goldPriceChart.update();
        });
      }
      const recHistoryCtx = document.getElementById('recommendationHistoryChart')?.getContext('2d');
      if (recHistoryCtx) {
        new Chart(recHistoryCtx, {
          type:'bar',
          data:{ labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets:[{ label:'Recommendations', data:[5,7,6,8,4,2,3],
            backgroundColor:['rgba(75,192,192,0.6)','rgba(153,102,255,0.6)','rgba(255,159,64,0.6)','rgba(75,192,192,0.6)','rgba(153,102,255,0.6)','rgba(255,159,64,0.6)','rgba(75,192,192,0.6)'],
            borderColor:['rgba(75,192,192,1)','rgba(153,102,255,1)','rgba(255,159,64,1)','rgba(75,192,192,1)','rgba(153,102,255,1)','rgba(255,159,64,1)','rgba(75,192,192,1)'], borderWidth:1 }] },
          options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ labels:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } } },
            scales:{ x:{ grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } },
                    y:{ beginAtZero:true, grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } } }
          }
        });
      }

      // XAI charts
      const fiCtx = document.getElementById('featureImportanceChart')?.getContext('2d');
      if (fiCtx) {
        new Chart(fiCtx, {
          type:'bar',
          data:{ labels:['Market Trend','Volume','Sentiment','Economic Data','Volatility'],
                 datasets:[{ label:'Importance', data:[0.9,0.7,0.6,0.5,0.4],
                   backgroundColor:'rgba(255,215,0,0.6)', borderColor:'rgba(255,215,0,1)', borderWidth:1 }] },
          options:{ responsive:true, maintainAspectRatio:false, indexAxis:'y',
            plugins:{ legend:{ display:false }, title:{ display:false } },
            scales:{ x:{ grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } },
                    y:{ grid:{ color:'rgba(255,255,255,0.05)' }, ticks:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } } }
          }
        });
      }

      const bimCtx = document.getElementById('biasInfluenceMap')?.getContext('2d');
      if (bimCtx) {
        new Chart(bimCtx, {
          type:'doughnut',
          data:{ labels:['Overconfidence','Anchoring','Confirmation','Loss Aversion','Mitigated'],
                 datasets:[{ data:[15,10,8,12,55],
                   backgroundColor:['rgba(231,76,60,0.7)','rgba(241,196,15,0.7)','rgba(52,152,219,0.7)','rgba(149,165,166,0.7)','rgba(46,204,113,0.7)'],
                   borderColor:getComputedStyle(document.body).getPropertyValue('--card-bg'), borderWidth:2 }] },
          options:{ responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom', labels:{ color:getComputedStyle(document.body).getPropertyValue('--text-color') } },
                      title:{ display:false } }
          }
        });
      }

      // Load settings + defaults
      const loaded = await loadSettings();
      if (loaded) applyDefaultsToDecisionEngine(loaded);

      // Live API wiring
      document.getElementById('predictBtn')?.addEventListener('click', async () => {
        const raw = (document.getElementById('predictInput')?.value || '').trim();
        const arr = raw.split(',').map(n => Number(n.trim())).filter(n => !isNaN(n));
        const out = document.getElementById('predictResult');
        if (!arr.length) { out.textContent = 'Please enter a comma-separated list of numbers.'; return; }
        out.textContent = 'Loading...';
        try {
          const data = await apiFetch(ENDPOINTS.predict, { method: 'POST', body: JSON.stringify({ input: arr }) });
          out.textContent = JSON.stringify(data, null, 2);
          const ri = document.getElementById('resolveInput'); if (ri && !ri.value) ri.value = raw;
        } catch (e) { out.textContent = 'Error: ' + e.message; }
      });

      document.getElementById('analyzeBtn')?.addEventListener('click', async () => {
        const text = (document.getElementById('analyzeText')?.value || '').trim();
        const user_id = (document.getElementById('analyzeUserId')?.value || '').trim();
        const out = document.getElementById('analyzeResult');
        if (!text || !user_id) { out.textContent = 'Enter your trade idea and user ID.'; return; }
        out.textContent = 'Loading...';
        try {
          const data = await apiFetch(ENDPOINTS.analyzeText, { method: 'POST', body: JSON.stringify({ text, user_id }) });
          out.textContent = JSON.stringify(data, null, 2);
        } catch (e) { out.textContent = 'Error: ' + e.message; }
      });

      document.getElementById('resolveBtn')?.addEventListener('click', async () => {
        const seq = (document.getElementById('resolveInput')?.value || '').trim();
        const input = seq.split(',').map(n => Number(n.trim())).filter(n => !isNaN(n));
        const text = (document.getElementById('resolveText')?.value || '').trim();
        const user_id = (document.getElementById('resolveUserId')?.value || '').trim();
        const trading_style = document.getElementById('tradingStyle')?.value || '';
        const time_frame = document.getElementById('timeFrame')?.value || '';
        const investment_amount = Number(document.getElementById('investmentAmount')?.value || 0);
        const out = document.getElementById('resolveResult');

        if (!input.length || !text || !user_id || !trading_style || !time_frame || investment_amount <= 0) {
          out.textContent = 'Please fill in all fields with valid values.'; return;
        }
        out.textContent = 'Loading...';
        try {
          const data = await apiFetch(ENDPOINTS.resolve, {
            method: 'POST',
            body: JSON.stringify({ input, text, user_id, trading_style, investment_amount, time_frame })
          });
          out.textContent = JSON.stringify(data, null, 2);
          const fb = document.getElementById('feedbackSection'); if (fb) fb.style.display = 'block';
        } catch (e) { out.textContent = 'Error: ' + e.message; }
      });

      // Scenario Traceability
      document.getElementById('traceBtn')?.addEventListener('click', async () => {
        const id = (document.getElementById('recommendationId')?.value || '').trim();
        if (!id) { alert('Please enter a Recommendation ID.'); return; }

        const modalEl = document.getElementById('traceModal');
        const modal = new bootstrap.Modal(modalEl);
        const timeline = document.getElementById('traceTimeline');
        const summary = document.getElementById('traceSummary');

        timeline.innerHTML = '';
        summary.textContent = 'Loading…';
        modal.show();

        async function fetchTrace() {
          try {
            return await apiFetch(`${ENDPOINTS.trace}/${encodeURIComponent(id)}`, { method: 'GET' });
          } catch (e) {
            if (e.status === 404 || e.status === 400 || e.status === 405) {
              return await apiFetch(ENDPOINTS.trace, { method: 'POST', body: JSON.stringify({ id }) });
            }
            throw e;
          }
        }

        try {
          const data = await fetchTrace();
          const recId = data?.id || id;
          const created = data?.created_at ? new Date(data.created_at).toLocaleString() : '—';
          const sym = data?.symbol || '—';
          const dec = data?.decision;
          const decText = dec ? `${dec.action || '—'} ${dec.entry ?? '—'} → ${dec.target ?? '—'} (${dec.pips ?? '—'} pips)` : '—';

          summary.textContent = `ID: ${recId} • Created: ${created} • Symbol: ${sym} • Decision: ${decText}`;

          const steps = Array.isArray(data?.steps) ? data.steps : [];
          if (!steps.length) { timeline.innerHTML = `<li class="list-group-item">No trace steps available.</li>`; return; }

          const fr = document.createDocumentFragment();
          steps.forEach((s, idx) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';
            const left = document.createElement('div');
            left.className = 'ms-2 me-auto';
            const title = document.createElement('div');
            title.className = 'fw-bold';
            title.textContent = (s.type || 'step').toString().replace(/_/g, ' ');
            const detail = document.createElement('div');
            detail.textContent = s.detail || '';
            left.appendChild(title);
            left.appendChild(detail);

            const when = document.createElement('span');
            when.className = 'badge bg-secondary rounded-pill';
            when.textContent = s.ts ? new Date(s.ts).toLocaleTimeString() : `#${idx+1}`;

            li.appendChild(left);
            li.appendChild(when);
            fr.appendChild(li);
          });
          timeline.appendChild(fr);
        } catch (e) {
          summary.textContent = `Error: ${e.message}`;
          timeline.innerHTML = `<li class="list-group-item text-danger">Failed to load trace. Please verify the ID.</li>`;
        }
      });

      // Feedback
      document.getElementById('feedbackBtn')?.addEventListener('click', async () => {
        const user_id = (document.getElementById('resolveUserId')?.value || '').trim();
        const trading_style = document.getElementById('tradingStyle')?.value || '';
        const investment_amount = Number(document.getElementById('investmentAmount')?.value || 0);
        const followed_recommendation = document.getElementById('feedbackFollowed')?.value || '';
        const feedback_text = (document.getElementById('feedbackText')?.value || '').trim();
        const out = document.getElementById('feedbackResult');

        if (!user_id || !trading_style || investment_amount <= 0 || !followed_recommendation || !feedback_text) {
          out.textContent = 'Please complete all feedback fields.'; return;
        }
        out.textContent = 'Submitting...';
        try {
          const data = await apiFetch(ENDPOINTS.feedback, {
            method: 'POST',
            body: JSON.stringify({ user_id, trading_style, investment_amount, followed_recommendation, feedback_text })
          });
          out.textContent = data.message || 'Thanks for the feedback!';
          document.getElementById('feedbackText').value = '';
        } catch (e) { out.textContent = 'Error: ' + e.message; }
      });

      // Prefill user id if present
      const storedUserId = localStorage.getItem('user_id') || localStorage.getItem('userId') || '';
      if (storedUserId) {
        const a = document.getElementById('analyzeUserId'); if (a && !a.value) a.value = storedUserId;
        const r = document.getElementById('resolveUserId'); if (r && !r.value) r.value = storedUserId;
      }

      // Logout
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        const btn = document.getElementById('logoutBtn'), original = btn.textContent;
        btn.disabled = true; btn.textContent = 'Logging out...';
        try {
          if (localStorage.getItem('auth_token')) {
            try { await apiFetch(ENDPOINTS.logout, { method: 'POST' }); } catch (_) {}
          }
        } finally {
          localStorage.removeItem('auth_token'); localStorage.removeItem('user_id');
          window.location.href = LOGIN_URL;
          setTimeout(() => { btn.disabled = false; btn.textContent = original; }, 1200);
        }
      });
    });
  </script>
</body>
</html>
